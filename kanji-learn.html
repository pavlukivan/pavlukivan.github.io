<html>
<head>
<script src='sql-wasm.js'></script>
<link rel="stylesheet" type="text/css" href="style.css" media="screen" />
<script>
function gup(name, url) {
	if (!url) url = location.href;
	name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
	var regexS = "[\\?&]"+name+"=([^&#]*)";
	var regex = new RegExp( regexS );
	var results = regex.exec( url );
	return results == null ? null : results[1];
}

var hiragana = {
	standard: ['あ','い','う','え','お','か','き','く','け','こ','さ','し','す','せ','そ','た','ち','つ','て','と','な','に','ぬ','ね','の','は','ひ','ふ','へ','ほ','ま','み','む','め','も','ら','り','る','れ','ろ','や','ゆ','よ','わ','を','ん'],
	extended: ['が','ぎ','ぐ','げ','ご','ざ','じ','ず','ぜ','ぞ','だ','ぢ','づ','で','ど','ば','び','ぶ','べ','ぼ','ぱ','ぴ','ぷ','ぺ','ぽ'],
	combined: ['きゃ', 'きゅ', 'きょ', 'しゃ', 'しゅ', 'しょ', 'ちゃ', 'ちゅ', 'ちょ', 'にゃ', 'にゅ', 'にょ', 'ひゃ', 'ひゅ', 'ひょ', 'みゃ', 'みゅ', 'みょ', 'りゃ', 'りゅ', 'りょ'],
	extendedC: ['ぎゃ', 'ぎゅ', 'ぎょ', 'じゃ', 'じゅ', 'じょ', 'ぢゃ', 'ぢゅ', 'ぢょ', 'びゃ', 'びゅ', 'びょ', 'ぴゃ', 'ぴゅ', 'ぴょ'],
	little: ['ぁ','ぃ','ぅ','ぇ','ぉ','ゃ','ゅ','ょ','っ'],
};
var katakana = {
	standard: ['ア','イ','ウ','エ','オ','カ','キ','ク','ケ','コ','サ','シ','ス','セ','ソ','タ','チ','ツ','テ','ト','ナ','ニ','ヌ','ネ','ノ','ハ','ヒ','フ','ヘ','ホ','マ','ミ','ム','メ','モ','ラ','リ','ル','レ','ロ','ヤ','ユ','ヨ','ワ','ヲ','ン'],
	extended: ['ガ','ギ','グ','ゲ','ゴ','ザ','ジ','ズ','ゼ','ゾ','ダ','ヂ','ヅ','デ','ド','バ','ビ','ブ','ベ','ボ','パ','ピ','プ','ペ','ポ'],
};

var r2hPre = { };
var r2h = { 'ya': 'や', 'yo': 'よ', 'yu': 'ゆ', 'wa': 'わ', 'wo': 'を', 'nn': 'ん', '-': 'ー', 'ja': 'じゃ', 'jo': 'じょ', 'ju': 'じゅ' };
var r2hPost = { };
var r2hFinal = { };
var h2k = { 'や': 'ヤ', 'よ': 'ヨ', 'ゆ': 'ユ', 'わ': 'ワ', 'を': 'ヲ', 'ん': 'ン', 'ぁ': 'ァ', 'ぃ': 'ィ', 'ぅ': 'ゥ', 'ぇ': 'ェ', 'ぉ': 'ォ', 'っ': 'ッ', 'や': 'ヤ',　'ゆ': 'ユ',　'よ':　'ヨ' };

let starts = ['', 'k', 's', 't', 'n', 'h', 'm', 'r'];
let ends = ['a', 'i', 'u', 'e', 'o'];
let ends2 = ['ya', 'yu', 'yo'];

let i = 0;
let u = 0;
for(let j in starts) {
	for(let k in ends) {
		(starts[j] ? r2h : r2hPost)[starts[j] + ends[k]] = hiragana.standard[i];
		h2k[hiragana.standard[i]] = katakana.standard[i];
		++i;
	}
	for(let k in ends2)
		if(starts[j])
			r2hPre[starts[j] + ends2[k]] = hiragana.combined[u++];
	if(starts[j]) r2hFinal[starts[j]] = 'っ';
}
i = 0;
u = 0;
starts = ['g', 'z', 'd', 'b', 'p'];
for(let j in starts) {
	for(let k in ends) {
		r2h[starts[j] + ends[k]] = hiragana.extended[i];
		h2k[hiragana.extended[i]] = katakana.extended[i];
		++i;
	}
	for(let k in ends2)
		r2hPre[starts[j] + ends2[k]] = hiragana.extendedC[u++];
	r2hFinal[starts[j]] = 'っ';
}

var msPerQuestion = 5000;
var questionCount = 100;
var level = (+gup('level', '') || 0);
var startIdx = level * 48;
var wordCount = level == 40 ? 51 : 48;
</script>
</head>

<body>
	<div id="game-desc" class="text-output2"><span>You will be asked 100 questions where you need to <b>remember the word meaning and enter the readings</b> and then given your result in points (0-100). You have 5s per question, otherwise you get less points. However if you answer wrong, you get points subtracted. <b>If you don't know the meaning of the word</b> or don't remember the readings, <b>just press enter</b>. <b>You need to type like on an IME, nn=ん, zi=じ, ti=ち, etc</b></span></div>
<progress id="progress" value="0" max="100"></progress>
<div id="output" class="text-output" style="height: 30;">This is a tool to help learn new vocabulary as well as get used to IME input.</div>
<form id="user-form"><input type="text" id="user-input" class="text-input" disabled="true"/></form>
<div id="output2" class="text-output"></div>

</body>

<script>
var userInput=document.getElementById("user-input");
var userForm=document.getElementById("user-form");
var output=document.getElementById("output");
var output2=document.getElementById("output2");
var desc=document.getElementById("game-desc");
var progress=document.getElementById("progress");
progress.max = questionCount;

desc.innerHTML = "<span>You will be asked " + questionCount.toString() + " questions where you need to <b>remember the word meaning and enter the readings</b> and then given your result in points (0-" + questionCount.toString() + "). You have 5s per question, otherwise you get less points. However if you answer wrong, you get points subtracted. <b>If you don't know the meaning of the word</b> or don't remember the readings, <b>just press enter</b>. <b>You need to type like on an IME, nn=ん, zi=じ, ti=ち, etc</b></span>";

initSqlJs({ locateFile: filename => `/${filename}` }).then(function(SQL) {
var xhr = new XMLHttpRequest();
xhr.open('GET', 'words.db', true);
xhr.responseType = 'arraybuffer';
xhr.onload = e => {

var db = new SQL.Database(new Uint8Array(xhr.response));
let _i = 0;

let splitFurigana = (furi, html) => {
	let src = furi;
	let furiAll = furi.replace('&nbsp;', ' ').split('、　');
	if(furiAll.length == 1) furiAll = furiAll[0].split('、 ');
	if(furiAll.length == 1) furiAll = furiAll[0].split('、');
	if(furiAll.length == 1) furiAll = furiAll[0].split(',　');
	if(furiAll.length == 1) furiAll = furiAll[0].split(', ');
	if(furiAll.length == 1) furiAll = furiAll[0].split(',');
	if(!html) return furiAll.map(x => x.replace(/ /g, '').replace(/　/g, ''));
	let ret = furiAll.map(x => x.split(' ').map(x => x.split('[').join('<rt>').split(']').join('</rt>')).map(x => (x.indexOf('rt>') >= 0) ? ('<ruby>' + x + '</ruby>') : x).join(''));
	return ret;
};

let furiganaToHiragana = furi => {
	let i = 0;
	let src = furi.replace('&nbsp;', ' ');
	let furiAll = splitFurigana(src);
	let moreThanOne = 0;
	for(let r = 0; r < furiAll.length; ++r) {
		furiAll[r] = [...furiAll[r]].filter(x => hiragana.standard.indexOf(x) >= 0 || hiragana.extended.indexOf(x) >= 0 || hiragana.little.indexOf(x) >= 0).join('');
		/*furi = furiAll[r].split(' ');
		for(let j in furi) {
			moreThanOne = 0;
			while((i = furi[j].indexOf('[')) >= 0) {
				if(moreThanOne++) {
					break;
					console.log(src);
				}
				furi[j] = [...furi[j].substr(0, i)].filter(x => hiragana.standard.indexOf(x) >= 0 || hiragana.extended.indexOf(x) >= 0 || hiragana.little.indexOf(x) >= 0).join('') + furi[j].substr(i + 1);
				i = furi[j].indexOf(']');
				furi[j] = furi[j].substr(0, i) + furi[j].substr(i + 1);
			}
			if(moreThanOne == 2)
				break;
		}		
		if(moreThanOne == 2)
			break;
		furiAll[r] = furi;
		*/
	}
	/*
	if(moreThanOne == 2) {
		furiAll = src.split('　');
		for(let r = 0; r < furiAll.length; ++r)
			furiAll[r] = [furiAll[r].split('[').map(x => x.split(']')[0]).join('')];
	}*/
	//if(src[1] == '前') console.log(furiAll);
	return furiAll;//.map(x => x.join(''));
};

var contents =
	db.exec("SELECT * FROM notes")[0].values
	.map(x => x[6].split(''))
	.map(x => x.map(
		y => y.replace(/\<\/div\>/g, '').replace(/\<div\>/g, '').replace(/\<br\ \/\>/g, '').replace(/\<br\>/g, '')
	))
	.map(x => ({
		word: x[0],
		furigana: splitFurigana(x[1], true),
		answer: furiganaToHiragana(x[1]),
		translation: x[2].split(/,(?![^(]*\))/),
		index: _i++,
	}));
var contentsByWord = {};
for(let j in contents) {
	if(contentsByWord[contents[j].word]) {
		contentsByWord[contents[j].word].answer = [
			...new Set([
				...contentsByWord[contents[j].word].answer,
				...contents[j].answer
			])
		];
		contentsByWord[contents[j].word].translation = [
			...new Set([
				...contentsByWord[contents[j].word].translation,
				...contents[j].translation
			])
		];
		contentsByWord[contents[j].word].furigana = [
			...new Set([
				...contentsByWord[contents[j].word].furigana,
				...contents[j].furigana
			])
		];
	} else contentsByWord[contents[j].word] = contents[j];
}
contents = [];
for(let k in contentsByWord)
	contents.push(contentsByWord[k]);
contents.sort((a, b) => a.index - b.index);
for(let k in contents) contents[k].index = k;

userInput.focus();

output.textContent = "loaded";

var endIdx = Math.min(Math.floor(startIdx + wordCount), contents.length);
var weights = {};

for(var i = startIdx; i < endIdx; ++i)
	weights[i] = 1;

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; --i) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

var getNewQuestions = (count) => {
	var idxByWeight = {};
	for(var i in weights) {
		if(!idxByWeight[weights[i]]) idxByWeight[weights[i]] = [];
		idxByWeight[weights[i]].push(i);
	}
	var w = Object.keys(idxByWeight).sort((a, b) => b - a);
	var ret = [];
	for(var q in w) {
		var a = idxByWeight[w[q]].slice();
		shuffleArray(a);
		for(var i in a) {
			ret.push(a[i]);
		}
	}
	shuffleArray(ret);
	return ret.map(a => contents[a]);
};

var questions = getNewQuestions(wordCount);
var questionNum = 0;
var questionIdx = -1;

var standby = true;
output.textContent = "Press enter to start...";
userInput.disabled = false;
var score = 0;

let answers = [];
let ansCount = 0;

var questionTime = 0;

function rotateQuestion() {
	questionIdx += 1;
	progress.value = questionNum;
	if(questionIdx >= questions.length) questions = getNewQuestions(10), questionIdx = 0;
	question = questions[questionIdx];
	answers = question.answer.slice();
	ansCount = answers.length;
	console.log(question);
	questionNum += 1;
	questionTime = Date.now();
	
	output.textContent = question.word;
	userInput.value = "";
	userInput.focus();
}

var lastFlashID = -1;
var freeFlashID = 0;

function flashUserInput(color) {
	if(color != "") {
		var flashID = freeFlashID++;
		lastFlashID = flashID;
		userInput.style.background = color;
		setTimeout(function(){if(flashID == lastFlashID) flashUserInput("")}, 100);
	} else {
		userInput.style.background = "";
	}
}

let userText = '';

function checkAnswer(user, ans) {
	for(let from in r2hPre)
		user = user.split(from).join(r2hPre[from]);
	for(let from in r2h)
		user = user.split(from).join(r2h[from]);
	for(let from in r2hPost)
		user = user.split(from).join(r2hPost[from]);
	for(let from in r2hFinal)
		user = user.split(from).join(r2hFinal[from]);
	let ansk = ans.slice();
	let userk = user;
	for(let i in ansk) {
		for(let from in h2k)
			ansk[i] = ansk[i].split(from).join(h2k[from]);
	}
	for(let from in h2k)
		userk = userk.split(from).join(h2k[from]);
	userText = user;
	console.log(user, ans, userk, ansk);
	
	let i = ans.indexOf(user);
	if(i < 0) i = ansk.indexOf(userk);
	if(i < 0) return false;
	ans.splice(i, 1);
	return true;
}

var errors = {};

function handleSubmit(e) {
	e.preventDefault();
	
	let willStandby = false;
	if(!standby) {
		let scoreDelta = 0;
		if(checkAnswer(userInput.value, answers)) {
			if(Date.now() - questionTime <= msPerQuestion)
				scoreDelta = 1.0 / ansCount;
			else
				scoreDelta = 0.5 / ansCount;
			progress.value = +progress.value + 1.0 / ansCount;
		} else {
			output.textContent = "Incorrect! " + (userText ? ("You entered " + userText + ". ") : "") + "Press enter to continue...";
			output2.innerHTML = "<span>No, " + question.furigana.join('、') + " is " + question.translation.join(', ') + '</span>';
			willStandby = true;
			flashUserInput("#ff7070");
			scoreDelta = -0.5;
			errors[question.index] = (errors[question.index] | 0) + 1;
		}
		
		score += scoreDelta;
		weights[question.index] -= scoreDelta;
	}
	
	if(!standby && !willStandby && answers.length) {
		output.textContent += " again! There's another common reading.";
		questionTime = Date.now();
		userInput.value = "";
		userInput.focus();
	} else if(!standby && questionNum == questionCount) {
		progress.value = questionNum;
		userInput.value = "";
		userInput.disabled = true;
		output.textContent = "Your result: "+score.toString()+"/"+questionCount.toString();
		
		var errorArr = [];
		var errorArr = Object.keys(errors).map(function(key) {
			return [key, errors[key]];
		});
		
		errorArr.sort(function(first, second) {
			return second[1] - first[1];
		});
		
		if(errorArr.length > 0) {
			output2.innerHTML = "It seems like you had the most trouble with the following words:";
			errorArr.forEach(function(item) {
				output2.innerHTML
					+= "<span>"
					+ contents[item[0]].furigana.join('、')
					+ " - "
					+ item[1]
					+ "x error. The meaning is "
					+ contents[item[0]].translation.join(', ')
					+ ".</span>";
			});
		} else {
			output2.innerHTML = 'Congratulations! You made no errors. ' + (endIdx == contents.length) ? 'You have completed the final level!' : ('You may now <a href="kanji-learn.html?level=' + (level + 1) + '">proceed to the next level.</a>');
		}
	} else if(!willStandby) {
		rotateQuestion();
	}
	standby = willStandby;
	return false;
}

userForm.addEventListener('submit', handleSubmit);

}; //xhr
xhr.send();
}); //sql
</script>

</html>
