<html>
<head>
<script src='sql-wasm.js'></script>
<link rel="stylesheet" type="text/css" href="style.css" media="screen" />
<script>
function gup(name, url) {
	if (!url) url = location.href;
	name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
	var regexS = "[\\?&]"+name+"=([^&#]*)";
	var regex = new RegExp( regexS );
	var results = regex.exec( url );
	return results == null ? null : results[1];
}
var db2Ignore = ["それ","一","これ","時","分かる","何","今","今日","もう","人","出る","目","どこ","手","私","聞く","前","ここ","夏","いい","考える","知る","違う","自分","顔","誰","中","話","世界","良い","音","ちょっと","お前","こんな","また","俺","二","三","日","年","先","帰る","少し","上","入れる","入る","出来る","出す","本","体","口","男","女","子供","こう","昨日","時間","もっと","話す","書く","会う","仕事","他","歩く","部屋","無い","とても","作る","使う","みんな","悪い","忘れる","名前","いつ","取る","持つ","気持ち","生きる","先生","学校","教える","本当に","立つ","次","早い","始める","終わる","楽しい","欲しい","同じ","どうして","彼女","別","死ぬ","お願い","頭","あれ","感じる","一緒に","戻る","こっち","笑う","呼ぶ","大丈夫","力","空","子","女の子","家","明日","開く","聞こえる","人間","最初","後","最後","なぜ","ずっと","通り","白","料理","消える","思い出す","場所","受ける","問題","あなた","必要","こちら","変わる","やっぱり","きっと","以上","理由","信じる","存在","島","関係","殺す","星","夢","鏡","声","居る","つく","いつも","心","どんな","そこ","そして","さっき","あんな","それで","そういう","記憶","とりあえず","別に","意味","こいつ","狩り","学園","相手","様","君","あと","ひる","先輩","ちる","言葉","奴","頼む","身体","待つ","天使","つける","姿","少女","胸","続ける","確かに","普通","寝る","探す","食べる","一つ","十","金","小さい","多い","上げる","下","足","開ける","高い","朝","かなり","夜","飲む","買う","読む","止める","走る","長い","全部","店","決める","一番","勉強","強い","どれ","引く","ドア","座る","動く","終わり","服","娘","彼","答える","痛い","続く","落ちる","置く","起きる","授業","僕","分","行う","外","海","私たち","つまり","向かう","間","初めて","しばらく","合う","仕方","今度","未来","無理","ゆっくり","風","安心","おかしい","心配","なかなか","生徒","本当","全然","返す","そろそろ","約束","変","過去","教室","説明","実際","状況","参加","助ける","逃げる","隣","付く","困る","幸せ","愛","可愛い","泣く","恥ずかしい","桜","よろしく","驚く","匂い","頑張る","そんなに","一体","これから","数","当然","たくさん","どうか","屋上","当たり前","制服","嫌","いろいろ","気づく","昔","それでも","頃","瞬間","食う","視線","いきなり","救う","目の前","表情","結構","身","得る","様子","特に","理解","連中","ほとんど","興味","描く","腕","水着","ござる","なさる","度","思える","光","全て","嘘","見つめる","残る","優しい","怒る","確認","怖い","以外","冗談","笑顔","かかる","最近","現れる","大変","簡単","許す","室","絵","五","円","月","水","大きい","耳","友達","元気","後ろ","見つける","見つかる","場合","道","近く","白い","春","新しい","決まる","住む","重い","難しい","切る","変える","働く","遅い","始まる","ゲーム","お母さん","母","酒","日記","首","冷たい","神","起こす","あそこ","手伝う","嫌い","肩","嬉しい","木","十分","今まで","川","毎日","花","空気","雨","やはり","向こう","向く","会話","うまい","大事","止まる","渡す","部分","黒い","味","ベッド","町","物","受け取る","生活","練習","今回","回る","ひどい","作業","残す","返事","指","立てる","事実","過ぎる","いつか","面白い","写真","色々","形","窓","家族","うるさい","答え","特別","確か","祭り","完成","正直","選ぶ","事務所","深い","落とす","振る","横","守る","残念","奥","教師","壁","机","こんなに","掃除","ちょうど","馬鹿","女子","気分","クラス","全員","思わず","しっかり","人生","行動","終える","実は","血","調べる","何でも","大切","部活","疲れる","慣れる","卒業","着る","程度","さて","廊下","見上げる","扉","絶対","眺める","ガキ","あんまり","勝手","そもそも","携帯","不思議","牢獄","しかも","振り返る","それにしても","影","殴る","頷く","想像","息","反応","そいつ","一瞬","噂","隠す","病","その場","辺り","唇","ようやく","結局","頬","失う","一応","不安","握る","もう少し","番","可能性","送る","落ち着く","認める","付き合う","何度も","掴む","ふと","件","浮かぶ","仲間","命","枚","腰","連れる","合わせる","触れる","元","用","妙","訊く","逆","突然","綺麗","神様","隊長","蝕","面倒","情報","任せる","黙る","動き","近づく","軽い","怪我","伝える","叩く","離れる","謝る","再び","涙","席","進む","邪魔","集まる","どうやら","美術部","万","閉じる","近い","遠い","消す","売る","冬","熱い","質問","負ける","乗る","色","遊ぶ","妹","兄","飛ぶ","まずい","触る","掛ける","上がる","夕飯","食事","電話","作品","階段","届く","生まれる","女性","当たる","方法","借りる","期待","時期","ポケット","運ぶ","ナイフ","テキスト","間違い","間違う","結果","目的","危険","用意","準備","状態","集める","着替える","立派","捨てる","洗う","太陽","震える","秘密","訪れる","どっち","暇","裏","訳","誘う","誰か","迷惑","与える","珍しい","倒れる","眠る","寂しい","我慢","猫","大人","内","行事","格好","思い","差し出す","限り","現実","去る","流れる","じっと","過ごす","繰り返す","抱く","たしか","急ぐ","母親","撫でる","それぞれ","それとも","両手","覗く","羽根","少なくとも","相変わらず","意識","娼婦","恐怖","構う","痛み","距離","途中","魂","望む","自ら","もう一度","正しい","素直","呪い","求める","娼館","感情","床","抜ける","緊張","以前","調子","そっち","納得","王様","必死","貰う","どうしても","どうせ","かう","適当","本人","流す","点","抱える","他人","興奮","押す","出会う","奴ら","放つ","瞳","暗い","事件","作戦","今から","改めて","何故","貴様","千","少ない","休む","空く","大好き","ご飯","赤い","古い","どちら","弱い","テーブル","楽しむ","お父さん","親","お兄さん","結婚","起こる","甘い","辛い","美しい","鼻","おいしい","火","少年","下げる","協力","足りる","森","客","ホテル","明るい","北","方向","今夜","言い方","語る","文字","肉","夏休み","事情","思い出","荷物","打つ","投げる","プール","校長","経験","経つ","必ず","貸す","急","時代","増える","減る","降る","下着","真面目","スカート","人形","遊び","自然","忙しい","相談","進める","責任","壊れる","神社","建物","判断","どうぞ","趣味","付ける","失礼","素晴らしい","掲示板","鍵","髪","迎える","蹴る","食堂","風呂","すっかり","決して","知れる","受け入れる","済む","それから","地面","濡れる","師匠","遅刻","わざわざ","暮らす","視界","気に入る","寮","風景","せめて","飯","転校生","生","内容","繋がる","浮かべる","光景","移動","感謝","無視","部下","予想","周り","単に","やがて","あくまでも","勘違い","諦める","微妙","それなり","辿る","微笑む","感覚","変態","まさに","関わる","永遠","告白","告げる","腹","見回す","予定","本来","自殺","商店街","襲う","まとも","着く","例","否定","背後","ぶる","のる","もつ","委員会","覚悟","奪う","冷静","失敗","雰囲気","お話","罪","親父","無駄","話しかける","追う","輝く","運命","拾う","報告","まだまだ","応える","連絡","神父","二つ","四","百","今年","駅","広い","暑い","寒い","学生","勝つ","速い","若い","背","駄目","多く","山","男の子","雪","半分","やっと","朝食","マンション","遠く","どんどん","魚","考え","都合","パン","コーヒー","回す","変化","降りる","活動","動かす","表","音楽","薬","真っ赤","直す","直接","曲","彼ら","並ぶ","危ない","成功","原因","願う","案内","組織","光る","地球","断る","両親","詳しい","苦手","お礼","喜ぶ","迷う","得意","吸う","激しい","引っ張る","包む","遠慮","挨拶","喧嘩","椅子","イメージ","下さる","最高","世話","新人","知り合い","局","式","額","限界","ウサギ","素敵","臭い","笑み","路地","偶然","今更","懐かしい","文句","我々","もっとも","あんなに","放課後","突っ込む","そういった","依頼","抜く","周囲","傷","離す","いつの間にか","慌てる","ぼんやり","一気に","ちょっとした","余計","中身","意外","肌","疑問","敵","真剣","同士","取り戻す","伝わる","使える","救世主","無事","男子","香り","頂く","無言","この世","ふざける","仲","嫌う","再生","具合","自由","吐く","主","溢れる","ううん","退学","階","闇","組","余裕","秒","満足","疑う","一度","寄せる","生前","寄る","防疫","すげる","叶える","単純","全身","合宿","感触","舐める","例えば","器","見事","六","右","払う","しゃべる","去年","紙","歌う","お姉さん","悲しい","プログラム","人々","テレビ","入り口","ほぼ","明らか","はっきり","夕方","間に合う","事故","通る","地図","広がる","一部","ページ","お茶","用事","可能","ノート","買い物","取れる","ボール","重要","限る","切れる","脱ぐ","バイク","手紙","兄さん","船","デート","示す","命令","比べる","久しぶり","影響","揺れる","厳しい","歴史","紹介","焼く","撮る","鳴る","犬","柔らかい","天井","舌","眠い","丁寧","凄い","鞄","小","空間","言い出す","価値","最悪","性格","強引","勝負","当てる","込める","代わり","早速","現場","戦う","勢い","夜空","二人とも","タイプ","予感","部長","誰にも","何となく","捕まえる","散る","たまたま","転がる","尽くす","治癒","戻す","焦る","二度と","果たして","暗闇","叫ぶ","怪しい","自体","態度","混乱","どっか","イベント","漂う","許可","妄想","選択","響く","カウンター","組む","資料","睨む","お店","膝","たつ","正体","気配","暴力","楽","褒める","証拠","美味い","かねる","逃がす","張る","逸らす","挟む","巨大","自信","たまる","揃う","副","煙草","騙す","指先","無理矢理","話題","生徒会長","要するに","溶ける","立ち止まる","オナニー","真","上履き","入部","補習","部員","左","低い","昼","晩","短い","時計","線","父","病気","細い","億","大きさ","パソコン","下ろす","休み","人気","まとめる","今後","今朝","昨夜","覚ます","大会","通う","カメラ","解決","能力","有名","押さえる","当時","利用","立場","目立つ","動物","歌","メニュー","間違える","別れる","意見","注意","公園","正確","登る","条件","おじさん","泳ぐ","雲","位置","静か","細かい","貼る","薄い","よろしい","吹く","屋根","滑る","攻撃","恐ろしい","あっち","箱","袋","布団","隠れる","巻く","先日","足下","商人","才能","人物","性","済ませる","利く","返る","一切","さっぱり","型","三角形","平気","病院","もうすぐ","気のせい","飛び出す","悔しい","次に","試す","幼馴染","サボる","弾く","構える","至る","自覚","勘弁","刃","本物","含む","指示","覆う","抱きしめる","確実","沈黙","何度か","巻き込む","誤解","印象","恨む","喋る","してやる","仲良く","似合う","星空","成績","抵抗","信頼","漏れる","樹","野郎","脇","上手く","煙","いらっしゃる","生える","人影","疲れ","底","悲鳴","探る","華","日々","貴族","罹患","杯","保護","ですが","沈む","調査","礼","確かめる","機会","果たす","了解","幼い","呪う","いっそ","あれから","穴","そういうもの","市","刺激","役","キマイラ","この前","単なる","晴れる","閉める","電車","下りる","いずれ","かつて","昼休み","火事","黒","中心","トイレ","キャンプ","ピアノ","引き出し","試験","計算","割る","役に立つ","実行","発言","発見","計画","真っ白","種類","並べる","医者","警察","自宅","苦しい","迫る","越える","恋人","咲く","皿","玄関","掛かる","遭う","会","あえて","重ねる","受験","前回","錆","誰でも","染まる","間違いなく","つまらない","親指","彼氏","噛む","希望","勧誘","擦る","感動","伸びる","恐らく","到着","瞼","せずに","隙間","鋭い","扱い","追いかける","照れる","憧れる","縁","意地悪","拳","座","この先","無限","扱う","信用","行為","あらゆる","見た目","言い訳","注ぐ","いい加減","スマホ","抱きつく","宇宙","思考","めちゃくちゃ","理不尽","人類","感想","差す","少しずつ","そのよう","割","苦笑","浪人","反魂香","テンション","かすか","リンク","マカロン","地獄","校内","死者","機嫌","遺産","大した","お袋","狭い","儀式","友人","結ぶ","潰す","苦労","惚れる","通す","飛ばす","照らす","今でも","満ちる","いたす","銃","本部","犠牲","下層","傍","麻薬","爪","分身","宇宙船","倍","厨房","問う","派手","端","可哀想","犯す","処女","登校","おっさん","天才","芸術","日本","王子","七","時々","上手","天気","安い","大学","泊まる","弟","帰り","少々","下がる","一方","下手","青い","覚める","全体","全く","テスト","熱","ぶつかる","配る","届ける","入学","研究","複雑","クリスマス","遅れる","効果","ハンバーガー","一般","注文","具体的","基本","設計","施設","季節","壊す","ラーメン","管理","盗む","汚れる","片付ける","努力","あちら","乾く","刺す","柔道","丸い","きっかけ","好み","明かり","セット","交わす","ショック","新た","様々","受け止める","一生","最強","支える","実力","真実","おそらく","ついに","仮に","いろんな","湧く","見かける","大げさ","映る","液体","広場","祈る","混じる","夢中","観測","観察","門","サービス","人達","ある程度","速度","多少","化物","眉","おでん","等","うろつく","飼う","わずか","穏やか","心の中","警戒","真夏","甘える","くだらない","互いに","呼吸","やり方","脚","大体","毒","俯く","なんぞ","幹部","班","陽動","武器","聴く","本日","解く","満たす","全","詰め所","界","おまけ","次第","咲","道場","後輩","快感","役目","匹","将来","絡む","引っかかる","芸術家","改装","タマネギ","この","その","馬","あの","はい","なんで","俺たち","あたし","なるほど","すごい","駐在","ちゃんと","ありがとう","覚える","羽","そりゃ","しかし","まったく","ダメ","どういう","さすが","まさか","者","部","街","うち","とにかく","だいたい","たぶん","こういう","表示","向ける","背中","それに","うれしい","あの子","タダ","さらに","的","ふたり","よし","完全","取り出す","それだけ","いただく","バイト","回","戦線","こうして","てめぇ","んじゃ","大","所","いくら","助かる","名","ごめんなさい","予言","七夕","似る","いっぱい","立ち上がる","お金","まず","メイド","天文","お姉ちゃん","気付く","不","お弁当","どうでも","本気","正解","それなら","それより","それでは","メンバー","どうも","おかげ","なんとか","自身","ワシ","っぽい","キス","そうして","段","プラネタリウム","ため息","なくなる","汗","どの","あるいは","込む","いいえ","エッチ","ここから","申し訳","おっぱい","何だか","つい","いやいや","パンツ","剣","カレー","サンプル","ずいぶん","なんとなく","伸ばす","その後","相当","えーと","いくつ","気持ちいい","けっこう","同時に","おはよう","お腹","避ける","気持ちよい","違い","選択肢","そういや","建築","歳","そうやって","お兄ちゃん","そこから","くそ","アホ","ペニス","復讐","なにか","恐い","動揺","楽しみ","見付ける","おわん","食券","いちいち","すまん","先代","おかしな","やってくる","こら","さあ","しょうが","それほど","に対する","かよう","やばい","魔女","みなさん","ぬいぐるみ","囲む","普段","エロ","お互い","元々","口調","向日葵","祟り","願い","おいおい","こうやって","員","遺伝子","と言うか","世の中","委員","お客さん","とこ","気がつく","駆ける","恋","星座","かなう","さっさ","ついで","ところで","ネット","狙う","あれだけ","とっても","まくる","わく","台詞","キャラ","ドキドキ","と言っても","使命","意志","祟る","身請け","御三家","くすくす","ルール","自然科学","卿","名無し","整理","と共に","何だ","号","呟く","望遠鏡","頼る","バレンタイン","何故か","射精","後で","指さす","着替え","酷い","おやすみ","それなのに","校舎","王","祭","いじめる","だいぶ","チラシ","デッサン","伝承","怒り","父親","突く","さっそく","それら","ひたすら","姉妹","漫画","玉","違和感","大量","成長","背負う","回収","地下室","携帯電話","カップル","それと","チーム","パーツ","出かける","目指す","アドレス","とっくに","めぐる","不可能","目覚める","おまんこ","不気味","体力","持ち上げる","デザイン","全力","土","揉む","登録","裸","ありがたい","セクハラ","何もかも","既に","真似","耐える","脳","解説","逃げ出す","地","感","旧館","狂う","ただし","めんどくさい","不満","住人","掲げる","染める","沢山","海蛇","知識","精神","たまに","どちらか","人数","部室","集中","味方","埋める","稼ぐ","虫","こりゃ","トウモロコシ","やる気","代わりに","外す","授業中","老婆","迷子","あふれる","そしたら","その気","バレる","不意に","乗せる","何者","反省","残り","特殊","生徒会","硬い","繋ぐ","顔面","この辺","となく","宿命","引き受ける","徐々に","慎重","時点","解放","いつも通り","お客様","に関して","びっくり","ライブ","今のところ","何かしら","切り出す","刻む","勢いよく","基本的","意味不明","把握","片手","異常","週間","クソ","メガネ","会議","共に","完璧","最果て","浮く","終了","蓋","起こし","面接","勝手に","崩れる","思いつく","拭う","振り向く","旅","日常","水族館","玉手箱","砂浜","秘密基地","肯定","くさい","コンビニ","ほんの少し","再開","あげる","ない","する","いる","ある","なる","言う","でも","そんな","もの","行く","しまう","だから","わけ","方","しれる","ため","ところ","来る","思う","事","やる","できる","見える","ただ","まだ","おく","もらう","くださる","まま","好き","すぎる","もちろん","つもり","あまり","そのまま","すむ","やすい","唯一"];
var hiragana = {
	standard: ['あ','い','う','え','お','か','き','く','け','こ','さ','し','す','せ','そ','た','ち','つ','て','と','な','に','ぬ','ね','の','は','ひ','ふ','へ','ほ','ま','み','む','め','も','ら','り','る','れ','ろ','や','ゆ','よ','わ','を','ん'],
	extended: ['が','ぎ','ぐ','げ','ご','ざ','じ','ず','ぜ','ぞ','だ','ぢ','づ','で','ど','ば','び','ぶ','べ','ぼ','ぱ','ぴ','ぷ','ぺ','ぽ'],
	combined: ['きゃ', 'きゅ', 'きょ', 'しゃ', 'しゅ', 'しょ', 'ちゃ', 'ちゅ', 'ちょ', 'にゃ', 'にゅ', 'にょ', 'ひゃ', 'ひゅ', 'ひょ', 'みゃ', 'みゅ', 'みょ', 'りゃ', 'りゅ', 'りょ'],
	extendedC: ['ぎゃ', 'ぎゅ', 'ぎょ', 'じゃ', 'じゅ', 'じょ', 'ぢゃ', 'ぢゅ', 'ぢょ', 'びゃ', 'びゅ', 'びょ', 'ぴゃ', 'ぴゅ', 'ぴょ'],
	little: ['ぁ','ぃ','ぅ','ぇ','ぉ','ゃ','ゅ','ょ','っ'],
};
var katakana = {
	standard: ['ア','イ','ウ','エ','オ','カ','キ','ク','ケ','コ','サ','シ','ス','セ','ソ','タ','チ','ツ','テ','ト','ナ','ニ','ヌ','ネ','ノ','ハ','ヒ','フ','ヘ','ホ','マ','ミ','ム','メ','モ','ラ','リ','ル','レ','ロ','ヤ','ユ','ヨ','ワ','ヲ','ン'],
	extended: ['ガ','ギ','グ','ゲ','ゴ','ザ','ジ','ズ','ゼ','ゾ','ダ','ヂ','ヅ','デ','ド','バ','ビ','ブ','ベ','ボ','パ','ピ','プ','ペ','ポ'],
};

let isKanji = ch => (ch >= "\u4e00" && ch <= "\u9faf") || (ch >= "\u3400" && ch <= "\u4dbf");
let isAscii = ch => (ch >= "\0" && ch <= "\x7F");

var r2hPre = { };
var r2h = { 'ya': 'や', 'yo': 'よ', 'yu': 'ゆ', 'wa': 'わ', 'wo': 'を', 'nn': 'ん', '-': 'ー', 'ja': 'じゃ', 'jo': 'じょ', 'ju': 'じゅ' };
var r2hPost = { };
var r2hFinal = { };
var h2k = { 'や': 'ヤ', 'よ': 'ヨ', 'ゆ': 'ユ', 'わ': 'ワ', 'を': 'ヲ', 'ん': 'ン', 'ぁ': 'ァ', 'ぃ': 'ィ', 'ぅ': 'ゥ', 'ぇ': 'ェ', 'ぉ': 'ォ', 'っ': 'ッ', 'や': 'ヤ',　'ゆ': 'ユ',　'よ':　'ヨ' };

let starts = ['', 'k', 's', 't', 'n', 'h', 'm', 'r'];
let ends = ['a', 'i', 'u', 'e', 'o'];
let ends2 = ['ya', 'yu', 'yo'];

let i = 0;
let u = 0;
for(let j in starts) {
	for(let k in ends) {
		(starts[j] ? r2h : r2hPost)[starts[j] + ends[k]] = hiragana.standard[i];
		h2k[hiragana.standard[i]] = katakana.standard[i];
		++i;
	}
	for(let k in ends2)
		if(starts[j])
			r2hPre[starts[j] + ends2[k]] = hiragana.combined[u++];
	if(starts[j]) r2hFinal[starts[j]] = 'っ';
}
i = 0;
u = 0;
starts = ['g', 'z', 'd', 'b', 'p'];
for(let j in starts) {
	for(let k in ends) {
		r2h[starts[j] + ends[k]] = hiragana.extended[i];
		h2k[hiragana.extended[i]] = katakana.extended[i];
		++i;
	}
	for(let k in ends2)
		r2hPre[starts[j] + ends2[k]] = hiragana.extendedC[u++];
	r2hFinal[starts[j]] = 'っ';
}

var msPerQuestion = 5000;
var questionCount = 100;
var level = (+gup('level', '') || 0);
var level0 = level;
var db2 = level >= 41;
if(db2) level -= 41;
var showAnswers = (+gup('answers', '') || 0) ? true : false;
var startIdx = level * 48;
var wordCount = level == 40 ? 51 : 48;
</script>
</head>

<body>
<div id="game-desc" class="text-output2"><span>You will be asked 100 questions where you need to <b>remember the word meaning and enter the readings</b>. At the end you will get your result in points (0-100). You have 5s per question, otherwise you get less points. However if you answer wrong, you get points subtracted. <b>If you don't know the meaning of the word</b> or don't remember the readings, <b>just press enter</b>. <b>You need to type like on an IME, nn=ん, zi=じ, ti=ち, na=な, etc.</b></span></div>
<div id="warning" class="text-output2" style="color:#ff0000;display:none;">Warning: levels 42+ are currently experimental!</div>
<a href="kanji-learn.html" id="link-answers" class="text-output2" style="color: #5e5ef0;"></a>
<progress id="progress" value="0" max="100"></progress>
<div id="output" class="text-output" style="height: 30;">This is a tool to help learn new vocabulary as well as get used to IME input.</div>
<form id="user-form"><input type="text" id="user-input" class="text-input" disabled="true"/></form>
<div id="output2" class="text-output"></div>

</body>

<script>
var userInput=document.getElementById("user-input");
var userForm=document.getElementById("user-form");
var output=document.getElementById("output");
var output2=document.getElementById("output2");
var desc=document.getElementById("game-desc");
var progress=document.getElementById("progress");
var linkAnswers=document.getElementById("link-answers");
var warning=document.getElementById("warning");
if(db2) warning.style.display = "";
linkAnswers.textContent = showAnswers ? "Back to questions" : "Go to answers";
linkAnswers.href = "kanji-learn.html?level=" + level0 + '&answers=' + +!showAnswers;
progress.max = questionCount;

if(showAnswers) desc.style.display = userInput.style.display = progress.style.display = output.style.display = "none";

desc.innerHTML = "<span>You will be asked " + questionCount.toString() + " questions where you need to <b>remember the word meaning and enter the readings</b>. At the end you will get your result in points (0-" + questionCount.toString() + "). You have 5s per question, otherwise you get less points. However if you answer wrong, you get points subtracted. <b>If you don't know the meaning of the word</b> or don't remember the readings, <b>just press enter</b>. <b>You need to type like on an IME: nn=ん, zi=じ, ti=ち, na=な, etc.</b></span>";

initSqlJs({ locateFile: filename => `/${filename}` }).then(function(SQL) {
var xhr = new XMLHttpRequest();
xhr.open('GET', db2 ? 'words2.db' : 'words.db', true);
xhr.responseType = 'arraybuffer';
xhr.onload = e => {

var db = new SQL.Database(new Uint8Array(xhr.response));
let _i = 0;

let splitFurigana = (furi, html) => {
	let src = furi;
	let furiAll = furi.replace('&nbsp;', ' ').split('、　');
	if(furiAll.length == 1) furiAll = furiAll[0].split('、 ');
	if(furiAll.length == 1) furiAll = furiAll[0].split('、');
	if(furiAll.length == 1) furiAll = furiAll[0].split(',　');
	if(furiAll.length == 1) furiAll = furiAll[0].split(', ');
	if(furiAll.length == 1) furiAll = furiAll[0].split(',');
	if(!html) {
		furiAll = furiAll.map(x => x.replace(/　/g, ''));
		return furiAll.map(x => x.replace(/ /g, ''));
	}
	
	let ret = furiAll.map(x => x.split(' ').map(x => x.split('[').join('<rt>').split(']').join('</rt>')).map(x => (x.indexOf('rt>') >= 0) ? ('<ruby>' + x + '</ruby>') : x).join(''));
	return ret;
};

let furigana2HtmlNoSplit = furi => {
	let src = furi.replace('&nbsp;', ' ');
	let wasKanji = undefined;
	let kanji = undefined;
	let wasAlpha = undefined;
	let alpha = undefined;
	let ret = '';
	let s = '';
	let kanjiStart = -1;
	let cont = () => {
		if(!s) return;
		if(wasKanji) kanjiStart = ret.length;
		else if(s.startsWith('[') && s.indexOf(']') >= 0) {
			let s2 = s.substr(s.indexOf(']') + 1);
			s = '<rt>' + s.substr(1, s.indexOf(']') - 1) + '</rt>';
			ret = ret.substr(0, kanjiStart) + '<ruby>' + ret.substr(kanjiStart) + s + '</ruby>' + s2;
			s = '';
			return;
		}
		ret += s;
		s = '';
	}
	for(let i = 0; i < furi.length; ++i) {
		kanji = isKanji(furi[i]);
		alpha = isAscii(furi[i]);
		if(wasAlpha && !alpha && furi[i-1] != ' ' && furi[i-1] != '[' && furi[i-1] != ']') s += ' / ';
		if(kanji != wasKanji) cont();
		s += furi[i];
		wasKanji = kanji;
		wasAlpha = alpha;
	}
	kanji = undefined;
	cont();
	return ret;
};

let furiganaToHiragana = furi => {
	let i = 0;
	let src = furi.replace('&nbsp;', ' ');
	let furiAll = splitFurigana(src);
	let moreThanOne = 0;
	for(let r = 0; r < furiAll.length; ++r) {
		let w = [...furiAll[r]];
		let n = w.indexOf('[') + 1;
		if(n) {
			for(let q in w) //save early hiragana
				if(!isKanji(w[q]))
					n = q;
				else
					break;
			furiAll[r] = w.filter((x, i) => !isKanji(x) && !isAscii(x) && x != '々' && i >= n).join('');
		}
		/*furi = furiAll[r].split(' ');
		for(let j in furi) {
			moreThanOne = 0;
			while((i = furi[j].indexOf('[')) >= 0) {
				if(moreThanOne++) {
					break;
					console.log(src);
				}
				furi[j] = [...furi[j].substr(0, i)].filter(x => hiragana.standard.indexOf(x) >= 0 || hiragana.extended.indexOf(x) >= 0 || hiragana.little.indexOf(x) >= 0).join('') + furi[j].substr(i + 1);
				i = furi[j].indexOf(']');
				furi[j] = furi[j].substr(0, i) + furi[j].substr(i + 1);
			}
			if(moreThanOne == 2)
				break;
		}		
		if(moreThanOne == 2)
			break;
		furiAll[r] = furi;
		*/
	}
	/*
	if(moreThanOne == 2) {
		furiAll = src.split('　');
		for(let r = 0; r < furiAll.length; ++r)
			furiAll[r] = [furiAll[r].split('[').map(x => x.split(']')[0]).join('')];
	}*/
	//if(src[1] == '前') console.log(furiAll);
	return furiAll;//.map(x => x.join(''));
};
let tmp;
var contents = db2
	? (db.exec("SELECT * FROM notes")[0].values
	.map(x => x[6].split(''))
	.map(x => x.map(
		y => y.replace(/\<\/div\>/g, '').replace(/\<div\>/g, '').replace(/\<br\ \/\>/g, '').replace(/\<br\>/g, '').replace(/\<b>/g, '').replace(/\<\/b>/g, '')
	))
	.filter(x => x[4] && db2Ignore.indexOf(x[2]) < 0))
	.map(x => ({
		word: x[2],
		furigana: x[7] ? splitFurigana(x[7], true) : [x[2]],
		translation: [(x[4] + (x[5] ? (' (' + x[5] + ')') : '')), ((x[8] && x[6]) ? 'Example - ' + furigana2HtmlNoSplit(x[8]) + '/　' + x[6] : '')].filter(x => !!x),
		index: _i++,
		answer: [x[3]],
	}))
	: (db.exec("SELECT * FROM notes")[0].values
	.map(x => x[6].split(''))
	.map(x => x.map(
		y => y.replace(/\<\/div\>/g, '').replace(/\<div\>/g, '').replace(/\<br\ \/\>/g, '').replace(/\<br\>/g, '')
	))
	.map(x => ({
		word: x[0],
		furigana: splitFurigana(x[1], true).filter(x => !!x),
		answer: [...new Set([...furiganaToHiragana(x[1])])].filter(x => !!x),
		translation: furigana2HtmlNoSplit(x[2]).split(/,(?![^(]*\))\s+/).filter(x => !!x),
		index: _i++,
	})));
console.log(contents);
var contentsByWord = {};
for(let j in contents) {
	if(contentsByWord[contents[j].word]) {
		contentsByWord[contents[j].word].answer = [
			...new Set([
				...contentsByWord[contents[j].word].answer,
				...contents[j].answer
			])
		].filter(x => !!x);
		contentsByWord[contents[j].word].translation = [
			...new Set([
				...contentsByWord[contents[j].word].translation,
				...contents[j].translation
			])
		].filter(x => !!x);
		contentsByWord[contents[j].word].furigana = [
			...new Set([
				...contentsByWord[contents[j].word].furigana,
				...contents[j].furigana
			])
		].filter(x => !!x);
	} else contentsByWord[contents[j].word] = contents[j];
	if(contents[j].word.indexOf('九') >= 0) console.log(contents[j]);
}

contents = [];
for(let k in contentsByWord)
	contents.push(contentsByWord[k]);
contents.sort((a, b) => a.index - b.index);
for(let k in contents) contents[k].index = k;

output.textContent = "loaded";

var endIdx = Math.min(Math.floor(startIdx + wordCount), contents.length);
console.log(startIdx, endIdx);
var weights = {};

for(var i = startIdx; i < endIdx; ++i)
	weights[i] = 1;

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; --i) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

var getNewQuestions = (count, dontRandomize) => {
	var idxByWeight = {};
	for(var i in weights) {
		if(!idxByWeight[weights[i]]) idxByWeight[weights[i]] = [];
		idxByWeight[weights[i]].push(i);
	}
	var w = Object.keys(idxByWeight).sort((a, b) => b - a);
	var ret = [];
	for(var q in w) {
		var a = idxByWeight[w[q]].slice();
		if(!dontRandomize) shuffleArray(a);
		for(var i in a) {
			ret.push(a[i]);
			if(ret.length >= count) break;
		}
		if(ret.length >= count) break;
	}
	if(!dontRandomize) shuffleArray(ret);
	return ret.map(a => contents[a]);
};

var questions = getNewQuestions(wordCount, showAnswers);
var questionNum = 0;
var questionIdx = -1;

if(showAnswers) {
	output2.innerHTML = "<b>Word list:</b>";
	questions.forEach(function(item) {
		output2.innerHTML
			+= "<span>"
			+ item.furigana.join('、')
			+ " - "
			+ item.translation.join(', ') + (item.translation[item.translation.length - 1].endsWith(".") ? "" : ".")
			+ "</span>" + '<hr style="width:50%;text-align:center;margin-top:10px;margin-bottom:10px;border-width:0px;">';
	});
	return;
}

var standby = true;
output.textContent = "Press enter to start...";
userInput.disabled = false;
userInput.focus();
var score = 0;

let answers = [];
let ansCount = 0;

var questionTime = 0;

function rotateQuestion() {
	questionIdx += 1;
	progress.value = questionNum;
	if(questionIdx >= questions.length) questions = getNewQuestions(10), questionIdx = 0;
	question = questions[questionIdx];
	answers = question.answer.slice();
	ansCount = answers.length;
	console.log(question);
	questionNum += 1;
	questionTime = Date.now();
	
	output.textContent = question.word;
	userInput.value = "";
	userInput.focus();
}

var lastFlashID = -1;
var freeFlashID = 0;

function flashUserInput(color) {
	if(color != "") {
		var flashID = freeFlashID++;
		lastFlashID = flashID;
		userInput.style.background = color;
		setTimeout(function(){if(flashID == lastFlashID) flashUserInput("")}, 100);
	} else {
		userInput.style.background = "";
	}
}

let userText = '';

function checkAnswer(user, ans) {
	for(let from in r2hPre)
		user = user.split(from).join(r2hPre[from]);
	for(let from in r2h)
		user = user.split(from).join(r2h[from]);
	for(let from in r2hPost)
		user = user.split(from).join(r2hPost[from]);
	for(let from in r2hFinal)
		user = user.split(from).join(r2hFinal[from]);
	let ansk = ans.slice();
	let userk = user;
	for(let i in ansk) {
		for(let from in h2k)
			ansk[i] = ansk[i].split(from).join(h2k[from]);
	}
	for(let from in h2k)
		userk = userk.split(from).join(h2k[from]);
	userText = user;
	console.log(user, ans, userk, ansk);
	
	let i = ans.indexOf(user);
	if(i < 0) i = ansk.indexOf(userk);
	if(i < 0) return false;
	ans.splice(i, 1);
	return true;
}

var errors = {};

function handleSubmit(e) {
	e.preventDefault();
	
	let willStandby = false;
	if(!standby) {
		let scoreDelta = 0;
		if(checkAnswer(userInput.value, answers)) {
			if(Date.now() - questionTime <= msPerQuestion)
				scoreDelta = 1.0 / ansCount;
			else
				scoreDelta = 0.5 / ansCount;
			progress.value = +progress.value + 1.0 / ansCount;
		} else {
			output.textContent = "Incorrect! " + (userText ? ("You entered " + userText + ". ") : "") + "Press enter to continue...";
			output2.innerHTML = "<span>No, " + question.furigana.join('、') + " is " + question.translation.join(', ') + '</span>';
			willStandby = true;
			flashUserInput("#ff7070");
			scoreDelta = -0.5;
			errors[question.index] = (errors[question.index] | 0) + 1;
		}
		
		score += scoreDelta;
		weights[question.index] -= scoreDelta;
	}
	
	if(!standby && !willStandby && answers.length) {
		if(!output.textContent.endsWith('another common reading.')) output.textContent += " again! There's another common reading.";
		questionTime = Date.now();
		userInput.value = "";
		userInput.focus();
	} else if(!standby && questionNum == questionCount) {
		progress.value = questionNum;
		userInput.value = "";
		userInput.disabled = true;
		output.textContent = "Your result: "+score.toString()+"/"+questionCount.toString();
		
		var errorArr = [];
		var errorArr = Object.keys(errors).map(function(key) {
			return [key, errors[key]];
		});
		
		errorArr.sort(function(first, second) {
			return second[1] - first[1];
		});
		
		if(errorArr.length > 0) {
			output2.innerHTML = "It seems like you had the most trouble with the following words:";
			errorArr.forEach(function(item) {
				output2.innerHTML
					+= "<span>"
					+ contents[item[0]].furigana.join('、')
					+ " - "
					+ item[1]
					+ "x error. The meaning is "
					+ contents[item[0]].translation.join(', ') + (contents[item[0]].translation[contents[item[0]].translation.length - 1].endsWith(".") ? "" : ".")
					+ "</span>" + '<hr style="width:50%;text-align:center;margin-top:10px;margin-bottom:10px;border-width:0px;">';
			});
		} else {
			output2.innerHTML = 'Congratulations! You made no errors. ' + ((db2 && endIdx == contents.length) ? 'You have completed the final level!' : ('You may now <a href="kanji-learn.html?level=' + (level0 + 1) + '">proceed to the next level.</a>'));
		}
	} else if(!willStandby) {
		rotateQuestion();
	}
	standby = willStandby;
	return false;
}

userForm.addEventListener('submit', handleSubmit);

}; //xhr
xhr.send();
}); //sql
</script>

</html>
